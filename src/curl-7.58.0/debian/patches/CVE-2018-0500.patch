From cf5856113dfe8311c45a3afc3c588964ab49dd57 Mon Sep 17 00:00:00 2001
From: Daniel Stenberg <daniel@haxx.se>
Date: Wed, 13 Jun 2018 12:24:40 +0200
Subject: [PATCH] smtp: use the upload buffer size for scratch buffer malloc

... not the read buffer size, as that can be set smaller and thus cause
a buffer overflow!

Reported-by: Peter Wu
---
 lib/smtp.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

Index: curl-7.58.0/lib/smtp.c
===================================================================
--- curl-7.58.0.orig/lib/smtp.c	2018-07-04 10:18:10.932775886 -0400
+++ curl-7.58.0/lib/smtp.c	2018-07-04 10:18:10.932775886 -0400
@@ -1558,13 +1558,14 @@ CURLcode Curl_smtp_escape_eob(struct con
   if(!scratch || data->set.crlf) {
     oldscratch = scratch;
 
-    scratch = newscratch = malloc(2 * data->set.buffer_size);
+    scratch = newscratch = malloc(2 * UPLOAD_BUFSIZE);
     if(!newscratch) {
       failf(data, "Failed to alloc scratch buffer!");
 
       return CURLE_OUT_OF_MEMORY;
     }
   }
+  DEBUGASSERT(UPLOAD_BUFSIZE >= nread);
 
   /* Have we already sent part of the EOB? */
   eob_sent = smtp->eob;
